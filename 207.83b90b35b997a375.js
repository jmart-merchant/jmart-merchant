"use strict";(self.webpackChunkjysan=self.webpackChunkjysan||[]).push([[207],{77207:(Ft,b,s)=>{s.r(b),s.d(b,{ConversionModule:()=>Ot});var f=s(69808),c=s(93075),D=s(40520),P=s(23918),m=s(89854),T=s(69544),S=s(56104),U=s(91995),C=s(59516),E=s(15057),t=s(5e3),N=s(77501),V=s(79311),J=s(94114),G=s(61459),l=s(70655),j=s(42654),Q=s(591),Y=s(24850),R=s(80013),_=s(32146),v=s(80457),x=s(90193),O=s(7102),y=s(40703),I=s(72159);let k=(()=>{class i{constructor(o){this.modal=o}dismissModal(){this.modal.dismiss()}closeModal(){this.modal.close()}}return i.\u0275fac=function(o){return new(o||i)(t.Y36(y.Kz))},i.\u0275cmp=t.Xpm({type:i,selectors:[["j-conversion-success-modal"]],inputs:{fromBalance:"fromBalance",toBalance:"toBalance",description:"description"},decls:16,vars:7,consts:[[1,"modal-header","j-modal-header"],[1,"modal-body","j-modal-body","text-center","pb-4"],["src","/assets/img/history/modals/success.svg"],[1,"p2","mb-0","mt-4","text-muted"],[3,"money","showAllDecimals"],["src","/assets/icons/conversion/modal-success-arrow.svg"],[1,"p2","mb-0"],[1,"modal-footer","py-4","px-3","justify-content-center"],["translate","","type","button",1,"btn","btn-primary","btn-block","mb-3",3,"click"],["translate","","type","button",1,"btn","btn-static","btn-link","m-0",3,"click"]],template:function(o,e){1&o&&(t._UZ(0,"div",0),t.TgZ(1,"div",1),t._UZ(2,"img",2),t.TgZ(3,"p",3),t._UZ(4,"j-money",4),t.qZA(),t._UZ(5,"img",5),t.TgZ(6,"h3"),t._UZ(7,"j-money",4),t.qZA(),t.TgZ(8,"p",6),t._uU(9),t.ALo(10,"translate"),t.qZA()(),t.TgZ(11,"div",7)(12,"button",8),t.NdJ("click",function(){return e.closeModal()}),t._uU(13," CONVERSION.NAVIGATE_TO_HISTORY "),t.qZA(),t.TgZ(14,"button",9),t.NdJ("click",function(){return e.dismissModal()}),t._uU(15," SHARED.BACK_TO_HOME "),t.qZA()()),2&o&&(t.xp6(4),t.Q6J("money",e.fromBalance)("showAllDecimals",!0),t.xp6(3),t.Q6J("money",e.toBalance)("showAllDecimals",!0),t.xp6(2),t.Oqu(t.lcZ(10,5,e.description)))},directives:[I.y,m.Pi],pipes:[m.X$],styles:[""]}),i})();function H(i,r){if(1&i&&t._UZ(0,"p",10),2&i){const o=t.oxw();t.Q6J("innerHTML",o.errorText,t.oJD)}}let B=(()=>{class i{constructor(o){this.modal=o}dismissModal(){this.modal.dismiss()}closeModal(){this.modal.close()}}return i.\u0275fac=function(o){return new(o||i)(t.Y36(y.Kz))},i.\u0275cmp=t.Xpm({type:i,selectors:[["j-conversion-error-modal"]],inputs:{description:"description",errorText:"errorText"},decls:15,vars:5,consts:[[1,"modal-header","j-modal-header"],[1,"modal-body","px-4","pt-0","pb-4","text-center"],["src","/assets/img/history/modals/error.svg",3,"alt"],["translate","",1,"light","mb-3","mt-2"],[1,"m-0","text-muted"],["translate",""],["class","mt-3 mb-0 text-danger",3,"innerHTML",4,"ngIf"],[1,"modal-footer","py-4","px-3","justify-content-center"],["translate","","type","button",1,"btn","btn-primary","btn-block","mb-3",3,"click"],["translate","","type","button",1,"btn","btn-static","btn-link","m-0",3,"click"],[1,"mt-3","mb-0","text-danger",3,"innerHTML"]],template:function(o,e){1&o&&(t._UZ(0,"div",0),t.TgZ(1,"div",1),t._UZ(2,"img",2),t.ALo(3,"translate"),t.TgZ(4,"h3",3),t._uU(5,"SHARED.ERROR"),t.qZA(),t.TgZ(6,"p",4)(7,"span",5),t._uU(8),t.qZA()(),t.YNc(9,H,1,1,"p",6),t.qZA(),t.TgZ(10,"div",7)(11,"button",8),t.NdJ("click",function(){return e.closeModal()}),t._uU(12," SHARED.TRY_AGAIN "),t.qZA(),t.TgZ(13,"button",9),t.NdJ("click",function(){return e.dismissModal()}),t._uU(14," SHARED.BACK_TO_HOME "),t.qZA()()),2&o&&(t.xp6(2),t.s9C("alt",t.lcZ(3,3,"SHARED.ERROR")),t.xp6(6),t.Oqu(e.description),t.xp6(1),t.Q6J("ngIf",e.errorText))},directives:[m.Pi,f.O5],pipes:[m.X$],styles:[""]}),i})();var w=s(41359),$=s(57720),K=s(28706),q=s(26164),X=s(26484),z=s(19208),W=s(66013),tt=s(65212),ot=s(7500),et=s(27763),nt=s(70853),it=s(65243),st=s(85814),rt=s(50235),ct=s(81522);const at=["fromDropdown"],lt=["toDropdown"],ut=["purposeDropdown"],mt=["commissionAccountDropdown"];function dt(i,r){1&i&&t._UZ(0,"j-restricted-placeholder",2)}function ht(i,r){if(1&i&&t._UZ(0,"j-money",35),2&i){const o=t.oxw(2);t.Q6J("money",o.commission)}}function pt(i,r){1&i&&t._UZ(0,"span",36),2&i&&t.Q6J("translate","CONVERSION.COMMISSION_FALLBACK")}function vt(i,r){if(1&i&&(t.ynx(0),t._UZ(1,"j-money",40),t._uU(2," = "),t._UZ(3,"j-money",40),t.BQk()),2&i){const o=t.oxw(3);t.xp6(1),t.Q6J("showAllDecimals",!0)("money",o.rateFrom),t.xp6(2),t.Q6J("showAllDecimals",!0)("money",o.rateTo)}}function ft(i,r){if(1&i&&(t.TgZ(0,"h6",37)(1,"span",38),t._uU(2,"CONVERSION.RATE"),t.qZA(),t._uU(3,": "),t.TgZ(4,"span",39),t.YNc(5,vt,4,4,"ng-container",1),t.qZA()()),2&i){const o=t.oxw(2);t.xp6(4),t.Q6J("jLoading",o.isRateLoading)("jLoadingInverted",!0),t.xp6(1),t.Q6J("ngIf",!o.isRateLoading)}}function gt(i,r){if(1&i){const o=t.EpF();t.TgZ(0,"div",41)(1,"div"),t._uU(2),t.ALo(3,"translate"),t.qZA(),t.TgZ(4,"a",42),t.NdJ("click",function(n){return t.CHM(o),t.oxw(2).updateRate(n)}),t._uU(5,"CONVERSION.RATE_RETRY"),t.qZA()()}if(2&i){const o=t.oxw(2);t.xp6(2),t.Oqu(o.rateErrorDescription?o.rateErrorDescription:t.lcZ(3,1,"CONVERSION.RATE_ERROR"))}}function Ct(i,r){if(1&i&&(t.TgZ(0,"span",43),t._uU(1),t.qZA()),2&i){const o=r.$implicit,e=t.oxw(2);t.xp6(1),t.AsE(" ",e.getItemCode(o)," - ",e.getItemDescription(o)," ")}}function At(i,r){if(1&i&&(t.TgZ(0,"div",44)(1,"strong"),t._uU(2),t.qZA(),t.TgZ(3,"span"),t._uU(4," - "),t.qZA(),t.TgZ(5,"span"),t._uU(6),t.qZA()()),2&i){const o=r.$implicit,e=t.oxw(2);t.xp6(2),t.Oqu(e.getItemCode(o)),t.xp6(4),t.Oqu(e.getItemDescription(o))}}function St(i,r){if(1&i){const o=t.EpF();t.TgZ(0,"div",45)(1,"button",46),t.NdJ("click",function(){return t.CHM(o),t.oxw(2).edit()}),t._uU(2,"CONVERSION.SAVE"),t.qZA()()}if(2&i){const o=t.oxw(2);t.xp6(1),t.Q6J("jLoadingInverted",!0)("disabled",o.isRateLoading||o.isSubmitting)("jLoading",o.isSubmitting)}}function _t(i,r){if(1&i){const o=t.EpF();t.ynx(0),t.TgZ(1,"button",47),t.NdJ("click",function(){return t.CHM(o),t.oxw(3).createOnly()}),t._UZ(2,"span",48),t.TgZ(3,"span",19),t._uU(4," CONVERSION.FOR_SIGN "),t.qZA()(),t.TgZ(5,"button",49),t.NdJ("click",function(){return t.CHM(o),t.oxw(3).createAndSign()}),t._uU(6,"CONVERSION.SIGN"),t.qZA(),t.BQk()}if(2&i){const o=t.oxw(3);t.xp6(1),t.Q6J("disabled",o.isRateLoading||o.isSubmitting)("jLoading",o.isSubmitting)("jLoadingInverted",!0),t.xp6(1),t.Q6J("inlineSVG","/assets/icons/conversion/sign.svg"),t.xp6(3),t.Q6J("disabled",o.isRateLoading||o.isSubmitting)("jLoading",o.isSubmitting)}}function yt(i,r){if(1&i){const o=t.EpF();t.ynx(0),t.TgZ(1,"button",49),t.NdJ("click",function(){return t.CHM(o),t.oxw(3).createOnly()}),t._UZ(2,"span",48),t.TgZ(3,"span",19),t._uU(4," CONVERSION.FOR_SIGN "),t.qZA()(),t.BQk()}if(2&i){const o=t.oxw(3);t.xp6(1),t.Q6J("disabled",o.isRateLoading||o.isSubmitting)("jLoading",o.isSubmitting),t.xp6(1),t.Q6J("inlineSVG","/assets/icons/conversion/sign.svg")}}function bt(i,r){if(1&i&&(t.TgZ(0,"div",45),t.YNc(1,_t,7,6,"ng-container",1),t.YNc(2,yt,5,3,"ng-container",1),t.qZA()),2&i){const o=t.oxw(2);t.xp6(1),t.Q6J("ngIf",o.canSendAndSign),t.xp6(1),t.Q6J("ngIf",o.canSendOnly)}}function Tt(i,r){if(1&i){const o=t.EpF();t.ynx(0),t.TgZ(1,"form",3)(2,"div",4)(3,"div",5)(4,"h5",6),t._uU(5,"CONVERSION.FROM.TITLE"),t.qZA(),t.TgZ(6,"div",7)(7,"j-account-dropdown",8,9),t.NdJ("selected",function(n){return t.CHM(o),t.oxw().onFromSelect(n)}),t.qZA()(),t.TgZ(9,"div",7),t._UZ(10,"j-amount-input",10),t.qZA()(),t.TgZ(11,"div",11)(12,"button",12),t.NdJ("click",function(){return t.CHM(o),t.oxw().reverseAccounts()}),t.qZA()(),t.TgZ(13,"div",13)(14,"h5",6),t._uU(15,"CONVERSION.TO.TITLE"),t.qZA(),t.TgZ(16,"div",7)(17,"j-account-dropdown",14,15),t.NdJ("selected",function(n){return t.CHM(o),t.oxw().onToSelect(n)}),t.qZA()(),t.TgZ(19,"div",7),t._UZ(20,"j-amount-input",16),t.qZA()()(),t.TgZ(21,"div",17)(22,"div",18)(23,"span",19),t._uU(24,"CONVERSION.COMMISSION"),t.qZA(),t._uU(25,": "),t.YNc(26,ht,1,1,"j-money",20),t.YNc(27,pt,1,1,"span",21),t.qZA(),t.YNc(28,ft,6,3,"h6",22),t.YNc(29,gt,6,3,"div",23),t.qZA(),t.TgZ(30,"div",24)(31,"h5",6),t._uU(32,"CONVERSION.DETAILS.TITLE"),t.qZA(),t.TgZ(33,"div",25),t._UZ(34,"j-input",26),t.TgZ(35,"j-dropdown-input",27,28),t.NdJ("selected",function(n){return t.CHM(o),t.oxw().onPurposeSelect(n)}),t.YNc(37,Ct,2,2,"ng-template",null,29,t.W1O),t.YNc(39,At,7,2,"ng-template",null,30,t.W1O),t.qZA()(),t.TgZ(41,"div",7)(42,"j-account-dropdown",31,32),t.NdJ("selected",function(n){return t.CHM(o),t.oxw().onCommissionAccountSelect(n)}),t.qZA()(),t.TgZ(44,"div",7),t._UZ(45,"j-input",33),t.ALo(46,"async"),t.qZA()(),t.YNc(47,St,3,3,"div",34),t.YNc(48,bt,3,2,"div",34),t.qZA(),t.BQk()}if(2&i){const o=t.oxw();t.xp6(1),t.Q6J("formGroup",o.conversionForm),t.xp6(6),t.Q6J("hasError",o.f.from.invalid&&o.isSubmitted)("isLoading",o.isAccountsLoading)("accounts",o.fromAccounts)("isDisabledSelectable",!0),t.xp6(3),t.Q6J("hasError",o.f.fromAmount.invalid&&o.isSubmitted||o.fromAmountError)("formControl",o.f.fromAmount)("errorText",o.fromAmountError)("isDisabled",o.f.fromAmount.disabled)("currency",o.fromCurrency),t.xp6(2),t.Q6J("disabled",!o.isRateShown)("inlineSVG","/assets/icons/conversion/arrows.svg"),t.xp6(5),t.Q6J("isLoading",o.isAccountsLoading)("hasError",o.f.to.invalid&&o.isSubmitted)("accounts",o.toAccounts)("isDisabledSelectable",!0),t.xp6(3),t.Q6J("hasError",o.f.toAmount.invalid&&o.isSubmitted)("formControl",o.f.toAmount)("isDisabled",o.f.toAmount.disabled)("currency",o.toCurrency),t.xp6(6),t.Q6J("ngIf",o.commission),t.xp6(1),t.Q6J("ngIf",!o.commission),t.xp6(1),t.Q6J("ngIf",o.isRateShown&&!o.hasAccountFromRateError&&!o.hasAccountToRateError),t.xp6(1),t.Q6J("ngIf",o.hasAccountFromRateError||o.hasAccountToRateError),t.xp6(5),t.Q6J("formControl",o.f.documentNumber)("hasError",o.f.documentNumber.invalid&&o.isSubmitted)("isClearable",!1),t.xp6(1),t.Q6J("options",o.purposeList)("hasError",o.f.purpose.invalid&&o.isSubmitted),t.xp6(7),t.Q6J("isLoading",o.isAccountsLoading)("accounts",o.accounts)("isDisabledSelectable",!0),t.xp6(3),t.Q6J("inputExtra",t.lcZ(46,40,o.descriptionLengthMessage$))("formControl",o.f.description)("hasError",o.f.description.invalid&&o.isSubmitted)("errorText",o.mapDescriptionErrors())("maxLength",o.descriptionMaxLength)("isClearable",!1),t.xp6(2),t.Q6J("ngIf",o.isEditing),t.xp6(1),t.Q6J("ngIf",!o.isEditing)}}const L={backdropClass:"backdrop_light",windowClass:"modal_light modal_sm",backdrop:"static",centered:!0};var A=(()=>((A||(A={})).RATE_NOT_LOADED="rate_not_found",A))();let Nt=(()=>{class i{constructor(o,e,n,a,h,p,d,u,g,M,It,wt,Zt,Lt){this.conversionService=o,this.accountsService=e,this.paymentsService=n,this.companyService=a,this.maskedService=h,this.curSymbolPipe=p,this.modalService=d,this.router=u,this.route=g,this.notifierService=M,this.translateService=It,this.navService=wt,this.authorityPermissionsService=Zt,this.paymentsApiService=Lt,this.descriptionMaxLength=250,this.isSubmitted=!1,this.isRateLoading=!1,this.isEditing=!1,this.isLoading=!0,this.isRestricted=!1,this.isSubmitting=!1,this.isCommissionAccountSelectable=!1,this.rateFrom=null,this.rateTo=null,this.hasAccountFromRateError=!1,this.hasAccountToRateError=!1,this.rateErrorDescription="",this.commission=null,this.accounts=[],this.purposeList=[],this.subscription=new j.w,this.descriptionLengthMessage$=new Q.X(`0/${this.descriptionMaxLength}`),this.isAccountsLoading=!0,this.rateSubscription=null,this.conversionForm=new c.cw({id:new c.NI(null),from:new c.NI(null,c.kI.required),fromAmount:new c.NI("",c.kI.required),to:new c.NI(null,c.kI.required),toAmount:new c.NI("",c.kI.required),documentNumber:new c.NI("",c.kI.required),purpose:new c.NI("",c.kI.required),commission:new c.NI(null),commissionAccount:new c.NI(null),rate:new c.NI(null),description:new c.NI("",[c.kI.maxLength(this.descriptionMaxLength),c.kI.required])}),this.listenFromAmount(),this.listenToAmount(),this.listenDescription()}ngOnInit(){const o=this.route.params.subscribe(e=>{e.id&&(this.f.id.setValue(e.id),this.isEditing=!0)});this.subscription.add(o)}ngAfterViewInit(){this.getPermission().then(()=>{this.isRestricted?this.isLoading=!1:this.initPage()})}initPage(){const o=this.route.paramMap.pipe((0,Y.U)(()=>window.history.state)).subscribe(n=>{this.isEditing?this.loadEditConversion(this.f.id.value):n.repeatPaymentId?this.loadRepeatConversion(n.repeatPaymentId):this.loadNewConversion()}),e=this.conversionForm.valueChanges.subscribe(n=>{this.isSubmitted=!1});this.subscription.add(o),this.subscription.add(e)}ngOnDestroy(){this.subscription.unsubscribe()}getItemCode(o){return o.code||""}getItemDescription(o){return o.description||""}get f(){return this.conversionForm.controls}get fromAccounts(){return this.toCurrency===v.w.KZT?this.accounts.filter(o=>o.balance.currency!==v.w.KZT):this.accounts}get toAccounts(){return this.fromCurrency===v.w.KZT?this.accounts.filter(o=>o.balance.currency!==v.w.KZT):this.accounts}get canSendAndSign(){return this.companyService.isSecondaryAuthority()||this.companyService.isPrimaryAuthority()&&this.companyService.isSingleSignScheme()}get canSendOnly(){return this.companyService.isNoSignAuthority()||this.companyService.isPrimaryAuthority()&&this.companyService.isMultipleSignScheme()}get isRateShown(){return this.rateFrom&&this.rateTo||this.isRateLoading}get fromAmountError(){var o,e;return this.f.fromAmount.value&&this.maskedService.getNumberedAmount(this.f.fromAmount.value)>(null===(e=null===(o=this.f.from.value)||void 0===o?void 0:o.balance)||void 0===e?void 0:e.amount)?"ERRORS.NOT_ENOUGH_AMOUNT":null}onFromSelect(o){!o||(this.applyClearAmountsIfOnlyTwoAccountsRule(),this.applyClearOnFromSelectedRule(o),this.applySelectFromCompanionRule(o),this.selectFromAccount(o),this.recalculateToAmount(),this.commissionAccountDropdown.selectAccount(o),this.recalculateCommission())}onToSelect(o){!o||(this.applyClearAmountsIfOnlyTwoAccountsRule(),this.applyClearOnToSelectedRule(o),this.applySelectToCompanionRule(o),this.selectToAccount(o),this.recalculateToAmount())}onPurposeSelect(o){!o||(this.f.purpose.setValue(o),this.recalculateCommission())}onCommissionAccountSelect(o){!o||(this.f.commissionAccount.setValue(o),this.recalculateCommission())}reverseAccounts(){const o=this.f.from.value,e=this.f.to.value;this.selectFromAccount(e),this.fromDropdown.selectAccount(e),this.f.fromAmount.setValue("",{emitEvent:!1}),this.selectToAccount(o),this.toDropdown.selectAccount(o),this.f.toAmount.setValue("",{emitEvent:!1})}updateRate(o=null){null==o||o.preventDefault(),this.hasAccountFromRateError?this.recalculateFromAmount():this.recalculateToAmount()}mapDescriptionErrors(){return this.f.description.errors?this.f.description.errors.maxlength?"ERRORS.MAX_LENGTH":void 0:null}retrievePurposeList(){return(0,l.mG)(this,void 0,void 0,function*(){this.purposeList=yield this.conversionService.getPurposeList()})}retrieveAccounts(){return(0,l.mG)(this,void 0,void 0,function*(){this.isAccountsLoading=!0;try{const o=yield this.accountsService.getAccounts();this.accounts=o.filter(e=>{var n;return!!(null===(n=e.balance)||void 0===n?void 0:n.currency)&&e.accountType===S.Q5.ACCOUNT})}catch(o){}finally{this.isAccountsLoading=!1}this.applyTwoAccountsRule()})}createOnly(){return(0,l.mG)(this,void 0,void 0,function*(){if(this.isSubmitted=!0,this.paymentNumberStore=this.paymentsService.conversionPaymentNumber,this.conversionForm.invalid||this.fromAmountError)return void((this.hasAccountFromRateError||this.hasAccountToRateError)&&this.showRateNotLoadedNotification());this.isSubmitting=!0;const o=this.conversionForm.getRawValue();if(yield this.checkIfAllowedToCreate(o.amount))try{yield this.conversionService.createConversion(o),this.paymentNumberStore.entity=null,this.showSuccessModal("CONVERSION.CREATE.SUCCESS")}catch(n){const a=this.handleError(n);a&&this.showCreateError(a)}finally{this.isSubmitting=!1}else this.isSubmitting=!1})}createAndSign(){return(0,l.mG)(this,void 0,void 0,function*(){if(this.isSubmitted=!0,this.paymentNumberStore=this.paymentsService.conversionPaymentNumber,this.conversionForm.invalid||this.fromAmountError)return void((this.hasAccountFromRateError||this.hasAccountToRateError)&&this.showRateNotLoadedNotification());this.isSubmitting=!0;const o=this.conversionForm.getRawValue();if(yield this.checkIfAllowedToCreate(o.amount))try{let n;yield this.conversionService.createAndSignConversion(o),this.paymentNumberStore.entity=null,n=this.companyService.currentCompany.signatureScheme===x.x_.SINGLE_SIGN&&this.companyService.currentAuthority.authority===x.Ly.PRIMARY_SIGNATURE?"CONVERSION.CREATE_AND_SIGN.SUCCESS":"CONVERSION.SIGN_ONLY.SUCCESS",this.showSuccessModal(n,!0)}catch(n){const a=this.handleError(n);a&&this.showCreateAndSignError(a)}finally{this.isSubmitting=!1}else this.isSubmitting=!1})}checkIfAllowedToCreate(o){return(0,l.mG)(this,void 0,void 0,function*(){return yield this.paymentsApiService.checkAmountLimit(o,O.V_.CONVERSION)})}edit(){return(0,l.mG)(this,void 0,void 0,function*(){if(this.isSubmitted=!0,this.conversionForm.invalid)(this.hasAccountFromRateError||this.hasAccountToRateError)&&this.showRateNotLoadedNotification();else{this.isSubmitting=!0;try{yield this.conversionService.saveEditedConversion(this.conversionForm.value,this.originalPayment),this.showSuccessModal("CONVERSION.EDIT.SUCCESS")}catch(o){o.code===_.S.RATE_CHANGED?(this.showErrorNotification(o),this.updateRate()):this.showEditError(this.mapError(o))}finally{this.isSubmitting=!1}}})}loadRepeatConversion(o){return(0,l.mG)(this,void 0,void 0,function*(){this.isLoading=!0;const e=yield Promise.all([this.conversionService.getConversionById(o),this.retrievePurposeList(),this.retrieveAccounts(),this.setAutoNumeration()]),[n]=e;this.loadConversionFromPayment(n),this.isLoading=!1})}loadEditConversion(o){return(0,l.mG)(this,void 0,void 0,function*(){this.isLoading=!0;const e=yield Promise.all([this.conversionService.getConversionById(o),this.retrievePurposeList(),this.retrieveAccounts()]),[n]=e;this.f.documentNumber.setValue(n.details.documentId),this.loadConversionFromPayment(n),this.isLoading=!1})}listenDescription(){this.f.description.valueChanges.subscribe(o=>{this.descriptionLengthMessage$.next(`${o.length}/${this.descriptionMaxLength}`)})}showRateNotLoadedNotification(){const o=this.translateService.instant("CONVERSION.RATE_NOT_LOADED");this.notifierService.hideAll(),this.notifierService.notify("default",o)}showErrorNotification(o){if(o.code===_.S.RATE_CHANGED){const e=this.translateService.instant("CONVERSION.RATE_CHANGED");this.notifierService.hideAll(),this.notifierService.notify("default",e)}}loadConversionFromPayment(o){this.originalPayment=o,this.selectFromAccountByIban(o.details.payerIban),this.selectToAccountByIban(o.paymentRecipient.recipientAccount.iban),this.selectPurposeByCode(o.details.conversionPurpose.code);const e=this.maskedService.getMaskedAmount(o.details.paymentAmount.amount,this.curSymbolPipe.transform(o.details.paymentAmount.currency));this.f.fromAmount.patchValue(e),this.f.description.patchValue(o.details.description)}getPermission(){return(0,l.mG)(this,void 0,void 0,function*(){this.isRestricted=yield this.authorityPermissionsService.isRestricted(O.V_.CONVERSION)})}loadNewConversion(){return(0,l.mG)(this,void 0,void 0,function*(){this.isLoading=!0,yield Promise.all([this.retrievePurposeList(),this.retrieveAccounts(),this.setAutoNumeration()]),this.isLoading=!1})}selectPurposeByCode(o){const e=this.purposeList.find(n=>n.code===o);this.onPurposeSelect(e),this.purposeDropdown.selectItem(e)}selectToAccountByIban(o){const e=this.findAccountByIban(o);this.selectToAccount(e),this.toDropdown.selectAccount(e)}selectFromAccountByIban(o){const e=this.findAccountByIban(o);this.selectFromAccount(e),this.fromDropdown.selectAccount(e)}listenFromAmount(){const o=this.f.fromAmount.valueChanges.pipe((0,R.b)(500)).subscribe(e=>{!e||this.recalculateToAmount()});this.subscription.add(o)}listenToAmount(){const o=this.f.toAmount.valueChanges.pipe((0,R.b)(500)).subscribe(e=>{!e||this.recalculateFromAmount()});this.subscription.add(o)}applyTwoAccountsRule(){if(2===this.accounts.length&&this.accounts[0].balance.currency!==this.accounts[1].balance.currency){const o=this.accounts.filter(n=>n.balance.currency===v.w.KZT),e=o.length?o[0]:this.accounts[0];this.selectFromAccount(e),this.fromDropdown.selectAccount(e),this.applySelectFromCompanionRule(e)}}applySelectToCompanionRule(o){var e;if(2===(null===(e=this.accounts)||void 0===e?void 0:e.length)){const n=this.findUnselectedAccount(o);this.selectFromAccount(n),this.fromDropdown.selectAccount(n)}}applySelectFromCompanionRule(o){var e;if(2===(null===(e=this.accounts)||void 0===e?void 0:e.length)){const n=this.findUnselectedAccount(o);this.selectToAccount(n),this.toDropdown.selectAccount(n)}}applyClearAmountsIfOnlyTwoAccountsRule(){2===this.accounts.length&&(this.f.fromAmount.setValue(""),this.f.toAmount.setValue(""))}findUnselectedAccount(o){var e;return null===(e=this.accounts)||void 0===e?void 0:e.find(n=>n!==o)}findAccountByIban(o){var e;return null===(e=this.accounts)||void 0===e?void 0:e.find(n=>n.iban===o)}setAutoNumeration(){this.subscription.add(this.paymentsService.conversionPaymentNumber$.subscribe(o=>{this.f.documentNumber.setValue(o)}))}selectToAccount(o){var e;this.toCurrency=null===(e=o.balance)||void 0===e?void 0:e.currency,this.f.to.setValue(o)}selectFromAccount(o){var e;this.fromCurrency=null===(e=o.balance)||void 0===e?void 0:e.currency,this.f.from.setValue(o)}clearToAccount(){var o;this.toCurrency=null,this.f.to.setValue(null),null===(o=this.toDropdown)||void 0===o||o.clearSelected()}clearFromAccount(){var o;this.fromCurrency=null,this.f.from.setValue(null),null===(o=this.fromDropdown)||void 0===o||o.clearSelected()}applyClearOnFromSelectedRule(o){o===this.f.to.value&&this.clearToAccount()}applyClearOnToSelectedRule(o){o===this.f.from.value&&this.clearFromAccount()}recalculateAmount(o){const{source:e,target:n,sourceCurrency:a,targetCurrency:h,errorStateKey:p}=o;if(!this.fromCurrency||!this.toCurrency||!e.value)return;this.rateSubscription&&this.rateSubscription.unsubscribe(),n.disable({emitEvent:!1}),this.hasAccountToRateError=!1,this.hasAccountFromRateError=!1,this.isRateLoading=!0,this.rateErrorDescription="",this.rateFrom=null,this.rateTo=null;const d=this.maskedService.getNumberedAmount(e.value);this.rateSubscription=this.conversionService.getRateObservable({currencyFrom:this.fromCurrency,currencyTo:this.toCurrency,sum:{amount:d,currency:a}}).subscribe(u=>{this.f.rate.setValue(u),this.rateFrom=u.equation.from,this.rateTo=u.equation.to;const g=this.maskedService.getMaskedAmount(u.calculatedSum,this.curSymbolPipe.transform(h));n.patchValue(g,{emitEvent:!1}),n.enable({emitEvent:!1}),this.recalculateCommission(),this.isRateLoading=!1,this.rateSubscription=null},u=>{u.code===A.RATE_NOT_LOADED&&(this.rateErrorDescription=u.description),n.patchValue("",{emitEvent:!1}),n.enable({emitEvent:!1}),this[p]=!0,this.isRateLoading=!1,this.rateSubscription=null})}recalculateToAmount(){return(0,l.mG)(this,void 0,void 0,function*(){this.recalculateAmount({source:this.f.fromAmount,target:this.f.toAmount,sourceCurrency:this.fromCurrency,targetCurrency:this.toCurrency,errorStateKey:"hasAccountToRateError"})})}recalculateFromAmount(){return(0,l.mG)(this,void 0,void 0,function*(){this.recalculateAmount({source:this.f.toAmount,target:this.f.fromAmount,sourceCurrency:this.toCurrency,targetCurrency:this.fromCurrency,errorStateKey:"hasAccountFromRateError"})})}recalculateCommission(){var o;return(0,l.mG)(this,void 0,void 0,function*(){try{this.commission=yield this.conversionService.getCommission(this.conversionForm.getRawValue()),this.f.commission.setValue(this.commission),this.isCommissionAccountSelectable=(null===(o=this.commission)||void 0===o?void 0:o.amount)>0,this.isCommissionAccountSelectable&&void 0===this.commissionAccountDropdown.selectedAccount&&this.setSelectedDefaultCommissionAccount()}catch(e){this.commission=null}})}setSelectedDefaultCommissionAccount(){var o,e;1===this.accounts.length&&(null===(o=this.commissionAccountDropdown)||void 0===o||o.selectAccount(this.accounts[0]),this.onCommissionAccountSelect(this.accounts[0]));const n=this.accounts.filter(a=>a.balance.currency===v.w.KZT);1===(null==n?void 0:n.length)&&(null===(e=this.commissionAccountDropdown)||void 0===e||e.selectAccount(n[0]),this.onCommissionAccountSelect(n[0]))}showCreateError(o){return(0,l.mG)(this,void 0,void 0,function*(){try{yield this.showErrorModal("TRANSFERS.CREATE.ERROR",o),this.createOnly()}catch(e){this.navigateToHome()}})}showCreateAndSignError(o){return(0,l.mG)(this,void 0,void 0,function*(){try{yield this.showErrorModal("TRANSFERS.CREATE_AND_SIGN.ERROR",o),this.createAndSign()}catch(e){this.navigateToHome()}})}showEditError(o){return(0,l.mG)(this,void 0,void 0,function*(){try{yield this.showErrorModal("TRANSFERS.EDIT.ERROR",o),this.edit()}catch(e){this.navigateToHome()}})}showSuccessModal(o,e=!1){var n,a,h,p;return(0,l.mG)(this,void 0,void 0,function*(){const d=this.modalService.open(k,L);d.componentInstance.description=o;const u=this.maskedService.getNumberedAmount(this.f.fromAmount.value),g=this.maskedService.getNumberedAmount(this.f.toAmount.value);d.componentInstance.fromBalance={amount:u,currency:null===(a=null===(n=this.f.from.value)||void 0===n?void 0:n.balance)||void 0===a?void 0:a.currency},d.componentInstance.toBalance={amount:g,currency:null===(p=null===(h=this.f.to.value)||void 0===h?void 0:h.balance)||void 0===p?void 0:p.currency};try{yield d.result,this.navigateToHistory(e)}catch(M){this.navigateToHome()}})}showErrorModal(o,e){const n=this.modalService.open(B,L);return n.componentInstance.description=o,n.componentInstance.errorText=e,n.result}navigateToHome(){this.navService.retrieveContractBadges(),this.navService.retrieveLetterBadges(),this.router.navigate(["/"])}navigateToHistory(o=!1){this.navService.retrieveContractBadges(),this.navService.retrieveLetterBadges();let e=w.$9.FOR_SIGN;o&&this.companyService.isPrimaryAuthority()&&this.companyService.isSingleSignScheme()&&(e=w.$9.IN_PROGRESS),this.router.navigate(["/history/conversion"],{queryParams:{paymentStatus:e}})}handleError(o){if(o){if(o.code!==_.S.RATE_CHANGED)return this.paymentNumberStore.entity=this.f.documentNumber.value,this.mapError(o);this.showErrorNotification(o),this.updateRate()}}mapError(o){let e="";if(null==o?void 0:o.data){let n=0;for(const a in o.data)Object.prototype.hasOwnProperty.call(o.data,a)&&(n++>0&&(e+="<br>"),e+=`${o.data[a]}`)}else e=o.description||o.code||o;return e}}return i.\u0275fac=function(o){return new(o||i)(t.Y36($.r),t.Y36(S.iu),t.Y36(K.cR),t.Y36(q.J),t.Y36(X.O),t.Y36(z.M),t.Y36(y.FF),t.Y36(C.F0),t.Y36(C.gz),t.Y36(W.lG),t.Y36(m.sK),t.Y36(N.t),t.Y36(tt.Eg),t.Y36(ot.e6))},i.\u0275cmp=t.Xpm({type:i,selectors:[["j-conversion-form"]],viewQuery:function(o,e){if(1&o&&(t.Gf(at,5),t.Gf(lt,5),t.Gf(ut,5),t.Gf(mt,5)),2&o){let n;t.iGM(n=t.CRH())&&(e.fromDropdown=n.first),t.iGM(n=t.CRH())&&(e.toDropdown=n.first),t.iGM(n=t.CRH())&&(e.purposeDropdown=n.first),t.iGM(n=t.CRH())&&(e.commissionAccountDropdown=n.first)}},decls:2,vars:2,consts:[["label","PAYMENTS.RESTRICTED_PLACEHOLDER",4,"ngIf"],[4,"ngIf"],["label","PAYMENTS.RESTRICTED_PLACEHOLDER"],[1,"conversion",3,"formGroup"],[1,"conversion__main"],[1,"conversion__from"],["translate","",1,"mb-3"],[1,"form-group"],["label","CONVERSION.FROM.LABEL",3,"hasError","isLoading","accounts","isDisabledSelectable","selected"],["fromDropdown",""],["label","CONVERSION.AMOUNT",3,"hasError","formControl","errorText","isDisabled","currency"],[1,"conversion__arrows"],[3,"disabled","inlineSVG","click"],[1,"conversion__to"],["label","CONVERSION.TO.LABEL",3,"isLoading","hasError","accounts","isDisabledSelectable","selected"],["toDropdown",""],["label","CONVERSION.AMOUNT",3,"hasError","formControl","isDisabled","currency"],[1,"conversion__rates"],[1,"p3","text-muted"],["translate",""],[3,"money",4,"ngIf"],[3,"translate",4,"ngIf"],["class","d-inline-flex align-items-center",4,"ngIf"],["class","p3 text-muted mt-2",4,"ngIf"],[1,"conversion__details"],[1,"conversion__details-row"],["label","CONVERSION.DETAILS.DOCUMENT_NUMBER",3,"formControl","hasError","isClearable"],["label","CONVERSION.DETAILS.PURPOSE",3,"options","hasError","selected"],["purposeDropdown",""],["selectedTemplate",""],["optionTemplate",""],["label","CONVERSION.COMMISSION_ACCOUNT",3,"isLoading","accounts","isDisabledSelectable","selected"],["commissionAccountDropdown",""],["label","CONVERSION.DETAILS.DESCRIPTION","type","textarea",3,"inputExtra","formControl","hasError","errorText","maxLength","isClearable"],["class","form-footer",4,"ngIf"],[3,"money"],[3,"translate"],[1,"d-inline-flex","align-items-center"],["translate","",1,"text-muted","conversion__rate-label"],[1,"ml-2","conversion__rate","text-dark",3,"jLoading","jLoadingInverted"],[3,"showAllDecimals","money"],[1,"p3","text-muted","mt-2"],["href","#","translate","",1,"link",3,"click"],[1,"text-truncate"],[1,"py-2"],[1,"form-footer"],["type","button","translate","",1,"btn","btn-outline-primary",3,"jLoadingInverted","disabled","jLoading","click"],["type","button",1,"btn","btn-link",3,"disabled","jLoading","jLoadingInverted","click"],[1,"d-inline-block","mr-2",3,"inlineSVG"],["type","submit","translate","",1,"btn","btn-primary","ml-3",3,"disabled","jLoading","click"]],template:function(o,e){1&o&&(t.YNc(0,dt,1,0,"j-restricted-placeholder",0),t.YNc(1,Tt,49,42,"ng-container",1)),2&o&&(t.Q6J("ngIf",e.isRestricted),t.xp6(1),t.Q6J("ngIf",!e.isRestricted))},directives:[f.O5,et.G,c._Y,c.JL,c.sg,m.Pi,nt.S,it.l,c.JJ,c.oH,T.d$,I.y,st.T,rt.N,ct.i],pipes:[m.X$,f.Ov],styles:[".conversion__main[_ngcontent-%COMP%]{padding:1.5rem 0 0}@media (min-width: 960px){.conversion__main[_ngcontent-%COMP%]{display:grid;grid-template-columns:calc(50% - 24px) 40px calc(50% - 24px);grid-column-gap:.5rem;column-gap:.5rem}}.conversion__arrows[_ngcontent-%COMP%]{margin:1rem auto;text-align:center}@media (min-width: 960px){.conversion__arrows[_ngcontent-%COMP%]{margin:0;margin-top:5.5rem}}.conversion__arrows[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{width:40px;height:40px;outline:0;padding:0;border:0;background:none;box-shadow:none;border-radius:50%;transform:rotate(90deg);transition:all .2s ease-in-out}.conversion__arrows[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover:not([disabled]){background:#fff;box-shadow:0 0 1px #0000000a,0 0 2px #0000000f,0 4px 8px #0000000a}@media (min-width: 960px){.conversion__arrows[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{transform:rotate(0)}}.conversion__rate-label[_ngcontent-%COMP%]{font-weight:400}.conversion__rate[_ngcontent-%COMP%]{display:inline-block;position:relative;min-width:30px;height:24px}.conversion__rates[_ngcontent-%COMP%]{text-align:center;padding-bottom:1.5rem;border-bottom:1px solid rgba(183,190,197,.35)}.conversion__details[_ngcontent-%COMP%]{border-bottom:1px solid rgba(183,190,197,.35);padding:1.5rem 0 .5rem}@media (min-width: 960px){.conversion__details-row[_ngcontent-%COMP%]{display:grid;grid-template-columns:calc(35% - 10px) calc(65% - 10px);grid-column-gap:20px;column-gap:20px}}"]}),i})(),F=(()=>{class i{constructor(o,e,n){this.navService=o,this.featureFlagsService=e,this.location=n,this.featureFlagsService.checkFeatureRoute(E.Y.CONVERSION)}onClose(){this.navService.retrieveLetterBadges(),this.navService.retrieveContractBadges(),this.location.back()}}return i.\u0275fac=function(o){return new(o||i)(t.Y36(N.t),t.Y36(E.a),t.Y36(f.Ye))},i.\u0275cmp=t.Xpm({type:i,selectors:[["j-conversion"]],decls:7,vars:0,consts:[["closePosition","outside","colsClassList","offset-lg-1 col-lg-10 offset-xl-2 col-xl-8","headerClassList","bg-white",3,"closed"],[1,"account-header"],["translate","",1,"f-page-title"]],template:function(o,e){1&o&&(t.TgZ(0,"f-page",0),t.NdJ("closed",function(){return e.onClose()}),t.TgZ(1,"f-page-header")(2,"section",1)(3,"h1",2),t._uU(4,"CONVERSION.TITLE"),t.qZA()()(),t.TgZ(5,"f-page-body"),t._UZ(6,"j-conversion-form"),t.qZA()())},directives:[V.J,J.M,m.Pi,G.G,Nt],styles:["[_nghost-%COMP%]{background:#f6f7f8;display:block}"]}),i})();const Rt=[{path:"",component:F},{path:":id",component:F},{path:"**",redirectTo:""}];let xt=(()=>{class i{}return i.\u0275fac=function(o){return new(o||i)},i.\u0275mod=t.oAB({type:i}),i.\u0275inj=t.cJS({imports:[[C.Bz.forChild(Rt)],C.Bz]}),i})(),Ot=(()=>{class i{}return i.\u0275fac=function(o){return new(o||i)},i.\u0275mod=t.oAB({type:i}),i.\u0275inj=t.cJS({imports:[[f.ez,c.u5,c.UX,D.JF,P.hx,m.aw,T.vi,xt,S.jW,U.m]]}),i})()}}]);